<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sade Site Yönetim Paneli</title>
    
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=E&background=007bff&color=fff&rounded=true">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { 
            --bg-color: #f0f2f5; 
            --card-bg: #fff; 
            --gray-led: #999; 
            --green-led: #2ecc71; 
            --primary-blue: #007bff;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-color); 
            padding: 10px; 
            margin: 0;
            color: #333;
        }

        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            position: relative; 
            padding-top: 60px; 
        }

        h2 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; }

        /* Üst Panel Butonları */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: absolute;
            top: 10px;
            width: 100%;
        }

        /* Switch Tasarımı */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            background: #fff;
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(14px); }

        .reset-btn { 
            background: #6c757d; font-size: 12px; padding: 6px 12px; 
            border: none; border-radius: 6px; color: white; cursor: pointer;
        }

        .site-item { 
            background: var(--card-bg); border: 1px solid #ddd; 
            margin-bottom: 10px; border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.08); overflow: hidden;
        }

        .site-header { padding: 15px; display: flex; justify-content: space-between; font-weight: bold; align-items: center; }
        
        /* Sürükleme durumu için stil */
        .can-drag .site-header { cursor: grab; }
        .can-drag .site-header:active { cursor: grabbing; }
        .can-drag .drag-handle { color: var(--primary-blue); }

        .site-content { display: none; padding: 15px; border-top: 1px solid #eee; background: #fafafa; }
        .user-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .led { width: 18px; height: 18px; border-radius: 50%; background: var(--gray-led); cursor: pointer; flex-shrink: 0; transition: 0.3s; }
        .led.active { background: var(--green-led); box-shadow: 0 0 10px var(--green-led); }
        .user-info { display: flex; align-items: center; gap: 12px; flex-grow: 1; margin-right: 10px; }
        .status-text { font-size: 11px; color: #666; display: block; margin-top: 2px; }
        .controls { display: flex; gap: 8px; margin-top: 15px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        .add-btn { cursor: pointer; padding: 10px 16px; border: none; border-radius: 6px; background: var(--primary-blue); color: white; font-weight: 500; }
        .del-btn { background: #dc3545; font-size: 11px; padding: 6px 10px; border:none; color:white; border-radius:4px; cursor:pointer;}

        .drag-handle { color: #eee; margin-right: 8px; font-size: 18px; transition: 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div class="switch-container">
            <span>Sıralama</span>
            <label class="switch">
                <input type="checkbox" id="drag-switch" onchange="toggleDragAbility()">
                <span class="slider"></span>
            </label>
        </div>
        <button class="reset-btn" onclick="resetAllStatus()">Sıfırla</button>
    </div>

    <h2>Yönetim Paneli</h2>
    <div id="site-list"></div>
</div>

<script>
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbxnPZwEmtpCMSeWYdbDbDpIFQCJJIxfPui5Y1U6zu9AtyAX76rT0SmtyqiQHuUJUwcv/exec";

    const firebaseConfig = {
        apiKey: "AIzaSyA_AB1QtRr3bBHi5LXxeTKECtgPJrfyRa4",
        authDomain: "deneme-b8281.firebaseapp.com",
        projectId: "deneme-b8281",
        storageBucket: "deneme-b8281.firebasestorage.app",
        messagingSenderId: "844910163064",
        appId: "1:844910163064:web:f4ad80295fb39d1322698d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let siteler = ["HIZLICASİNO", "EGEBET", "KAVBET", "PUSULABET", "HITBET", "TURBOSLOT", "MATBET", "JOJOBET", "HOLİGAN", "BETSMOVE", "LUNABET", "MEGABAHİS", "ODEONBET", "MAVİBET", "ELİTCASİNO", "COINBAR", "NAKITBAHIS"];
    let sortableInstance;

    async function init() {
        const orderDoc = await db.collection("settings").doc("siteOrder").get();
        if (orderDoc.exists) { siteler = orderDoc.data().list; }
        renderSiteList();
    }

    function renderSiteList() {
        siteListContainer.innerHTML = "";
        siteler.forEach(siteAd => {
            const div = document.createElement('div');
            div.className = 'site-item';
            div.setAttribute('data-id', siteAd);
            div.innerHTML = `
                <div class="site-header">
                    <div onclick="toggleMenu('${siteAd}')" style="flex-grow: 1; display:flex; align-items:center;">
                        <span class="drag-handle">☰</span>
                        <span>${siteAd}</span>
                    </div>
                    <span id="count-${siteAd}" style="font-size:11px; color:#888;">...</span>
                </div>
                <div class="site-content" id="content-${siteAd}">
                    <div id="users-${siteAd}"></div>
                    <div class="controls">
                        <input type="text" id="input-${siteAd}" placeholder="Kullanıcı Adı">
                        <button class="add-btn" onclick="addUser('${siteAd}')">Ekle</button>
                    </div>
                </div>
            `;
            siteListContainer.appendChild(div);
            db.collection(siteAd).orderBy("createdAt", "asc").onSnapshot(snapshot => renderUsers(siteAd, snapshot));
        });

        sortableInstance = new Sortable(siteListContainer, { 
            animation: 150, 
            handle: '.site-header',
            disabled: true, // Başlangıçta kapalı
            onEnd: saveNewOrder 
        });
    }

    // Switch Kontrolü
    function toggleDragAbility() {
        const isEnabled = document.getElementById('drag-switch').checked;
        sortableInstance.option("disabled", !isEnabled);
        
        if (isEnabled) {
            document.getElementById('site-list').classList.add('can-drag');
        } else {
            document.getElementById('site-list').classList.remove('can-drag');
        }
    }

    function saveNewOrder() {
        const items = siteListContainer.querySelectorAll('.site-item');
        const newOrder = Array.from(items).map(item => item.getAttribute('data-id'));
        db.collection("settings").doc("siteOrder").set({ list: newOrder });
    }

    function toggleMenu(id) {
        let el = document.getElementById('content-' + id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    async function resetAllStatus() {
        if (!confirm("Tüm kod durumlarını sıfırlamak istiyor musunuz?")) return;
        for (const siteAd of siteler) {
            const snapshot = await db.collection(siteAd).where("status", "==", true).get();
            snapshot.forEach(async (doc) => {
                const userData = doc.data();
                db.collection(siteAd).doc(doc.id).update({ status: false, date: "" });
                fetch(GOOGLE_SHEET_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: "updateStatus", siteAd: siteAd, name: userData.name, status: false })
                });
            });
        }
        alert("Sıfırlandı.");
    }

    function addUser(siteAd) {
        const input = document.getElementById(`input-${siteAd}`);
        const userName = input.value.trim();
        if(!userName) return;
        db.collection(siteAd).add({ name: userName, status: false, date: "", createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        fetch(GOOGLE_SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "add", siteAd: siteAd, name: userName }) });
        input.value = "";
    }

    function toggleStatus(siteAd, docId, currentStatus, userName) {
        const newStatus = !currentStatus;
        let dateStr = "";
        if(newStatus) {
            const d = new Date();
            dateStr = d.toLocaleDateString('tr-TR') + " " + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        }
        db.collection(siteAd).doc(docId).update({ status: newStatus, date: dateStr });
        fetch(GOOGLE_SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "updateStatus", siteAd: siteAd, name: userName, status: newStatus }) });
    }

    function deleteUser(siteAd, docId) {
        if(confirm("Silmek istediğinize emin misiniz?")) {
            db.collection(siteAd).doc(docId).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    fetch(GOOGLE_SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete", siteAd: siteAd, name: userData.name }) });
                    db.collection(siteAd).doc(docId).delete();
                }
            });
        }
    }

    function renderUsers(siteAd, snapshot) {
        const container = document.getElementById(`users-${siteAd}`);
        const countDisplay = document.getElementById(`count-${siteAd}`);
        container.innerHTML = "";
        countDisplay.innerText = snapshot.size + " Kişi";
        snapshot.forEach(doc => {
            const user = doc.data();
            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `
                <div class="user-info">
                    <div class="led ${user.status ? 'active' : ''}" onclick="toggleStatus('${siteAd}', '${doc.id}', ${user.status}, '${user.name}')"></div>
                    <div>
                        <strong>${user.name}</strong> 
                        <span class="status-text">${user.status ? `✅ ${user.date} Kod Alındı` : '❌ Kod Alınmadı'}</span>
                    </div>
                </div>
                <button class="del-btn" onclick="deleteUser('${siteAd}', '${doc.id}')">Sil</button>
            `;
            container.appendChild(row);
        });
    }

    const siteListContainer = document.getElementById('site-list');
    init();
</script>
</body>
</html>
