<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promosyon Kontrol Paneli</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --border-color: #30363d;
            --text-gold: #ffcc00;
            --text-white: #c9d1d9;
            --green-led: #00ff00;
            --gray-led: #484f58;
            --red-delete: #da3633;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
        }

        .container { width: 100%; max-width: 500px; }
        h2 { color: white; margin-bottom: 15px; text-align: left; font-size: 1.4rem; }

        .add-user-section {
            background: var(--card-bg);
            padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;
        }

        @media (min-width: 400px) {
            .add-user-section { flex-direction: row; }
            .add-user-section select { flex: 1; }
            .add-user-section input { flex: 2; }
        }

        select, input, button {
            background: #0d1117; border: 1px solid var(--border-color);
            color: white; padding: 10px; border-radius: 6px; outline: none; font-size: 0.9rem;
        }

        .btn-add { background: #238636; cursor: pointer; border: none; font-weight: bold; }
        .btn-add:hover { background: #2ea043; }

        .site-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 12px; margin-bottom: 15px;
        }

        .site-header { display: flex; align-items: center; margin-bottom: 12px; height: 28px; }
        .site-header-logo { height: 100%; max-width: 110px; object-fit: contain; }

        .user-row {
            background: #0d1117; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 10px; display: flex;
            justify-content: space-between; align-items: center; margin-top: 6px;
        }

        .user-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .user-name { font-weight: 500; font-size: 0.95rem; color: #e6edf3; }

        .btn-delete {
            background: transparent; border: 1px solid #30363d; color: #8b949e;
            padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
            transition: 0.2s;
        }
        .btn-delete:hover { background: var(--red-delete); color: white; border-color: var(--red-delete); }

        .led-container { display: flex; gap: 10px; align-items: center; }
        .led {
            width: 28px; height: 28px; border-radius: 50%;
            border: 2px solid #000; transition: all 0.3s ease; cursor: pointer;
        }

        .led-status-gray { background-color: var(--gray-led); box-shadow: inset 0 0 5px #000; }
        .led-status-green { 
            background-color: var(--green-led); 
            box-shadow: 0 0 10px var(--green-led), inset 0 0 5px #fff; 
        }

        .log-section {
            margin-top: 20px; background: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; width: 100%;
        }
        .log-header { color: var(--text-gold); font-weight: bold; margin-bottom: 8px; font-size: 0.85rem; }
        .log-list {
            background: #0d1117; border: 1px dotted var(--border-color);
            padding: 5px; font-size: 0.75rem; max-height: 200px; overflow-y: auto; border-radius: 5px;
        }
        .log-item { display: flex; align-items: center; padding: 6px 4px; border-bottom: 1px solid #21262d; color: #8b949e; }
        .log-date { color: #6e7681; font-size: 0.65rem; min-width: 70px; }
        .site-badge { background: #30363d; padding: 1px 5px; border-radius: 3px; margin-right: 5px; font-size: 0.65rem; }
        .action-text { color: #7ee787; margin-left: auto; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; width: 85%; max-width: 320px; text-align: center;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>Genel Kontrol</h2>

    <div class="add-user-section">
        <select id="siteSelect">
            <option value="KAVBET">KAVBET</option>
            <option value="EGEBET">EGEBET</option>
            <option value="LUNABET">LUNABET</option>
            <option value="MATBET">MATBET</option>
            <option value="MAVIBET">MAVIBET</option>
            <option value="MEGABAHIS">MEGABAHIS</option>
            <option value="NAKITBAHIS">NAKITBAHIS</option>
            <option value="ODEONBET">ODEONBET</option>
            <option value="PUSULABET">PUSULABET</option>
            <option value="JOJOBET">JOJOBET</option>
        </select>
        <input type="text" id="usernameInput" placeholder="Kullanıcı Adı">
        <button class="btn-add" onclick="addUser()">EKLE</button>
    </div>

    <div id="contentArea"></div>

    <div class="log-section">
        <div class="log-header">PROMOSYON LOGLARI</div>
        <div class="log-list" id="logList"></div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <div style="color:var(--text-gold); font-weight:bold; margin-bottom:10px;">ONAY</div>
        <div id="modalMessage" style="font-size: 0.9rem;"></div>
        <div class="modal-buttons">
            <button class="modal-btn" style="background:#da3633; color:white;" id="confirmBtn">EVET</button>
            <button class="modal-btn" style="background:#30363d; color:white;" onclick="closeModal()">İPTAL</button>
        </div>
    </div>
</div>

<script>
    const siteLogos = {
        'KAVBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/kavbet.png?raw=true',
        'EGEBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/egebet.png?raw=true',
        'LUNABET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/lunabet.png?raw=true',
        'MATBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/matbet.png?raw=true',
        'MAVIBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/mavibet.png?raw=true',
        'MEGABAHIS': 'https://github.com/trmaxturk/every-takip/blob/main/badges/megabahis.png?raw=true',
        'NAKITBAHIS': 'https://github.com/trmaxturk/every-takip/blob/main/badges/nakitbahis.png?raw=true',
        'ODEONBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/odeonbet.png?raw=true',
        'PUSULABET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/pusulabet.png?raw=true',
        'JOJOBET': 'https://github.com/trmaxturk/every-takip/blob/main/badges/bobobet.png?raw=true'
    };

    // TEMİZLİK MOTORU: İstediğin kullanıcıları zorla siler
    function forceCleanup() {
        const initialCount = users.length;
        users = users.filter(u => {
            const isKavbetTarget = (u.site === "KAVBET" && u.username.toLowerCase() === "trmaxturk");
            const isOdeonTarget = (u.site === "ODEONBET" && u.username.toLowerCase() === "maxbaba");
            return !isKavbetTarget && !isOdeonTarget;
        });
        
        if (users.length !== initialCount) {
            saveData();
        }
    }

    window.onload = () => { 
        forceCleanup(); // Önce temizle
        renderUI(); 
        renderLogs(); 
    };

    function saveData() {
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('logs', JSON.stringify(logs));
    }

    function addUser() {
        const site = document.getElementById('siteSelect').value;
        const username = document.getElementById('usernameInput').value.trim();
        if (!username) return;

        if (users.find(u => u.site === site && u.username.toLowerCase() === username.toLowerCase())) {
            alert('Bu kullanıcı zaten ekli!'); return;
        }

        users.push({ id: 'u' + Date.now(), site, username, lastClaimDate: null });
        saveData();
        renderUI();
        document.getElementById('usernameInput').value = '';
    }

    function deleteUser(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        showModal(`${user.username} silinsin mi?`, () => {
            users = users.filter(u => u.id !== userId);
            saveData();
            renderUI();
            closeModal();
        });
    }

    function handleClaim(userId) {
        const index = users.findIndex(u => u.id === userId);
        if (index === -1) return;
        const today = new Date().toLocaleDateString('tr-TR');
        const user = users[index];

        if (user.lastClaimDate === today) {
            showModal("Durumu sıfırlamak istiyor musunuz?", () => {
                users[index].lastClaimDate = null;
                logs = logs.filter(l => !(l.userId === userId && l.date === today));
                saveData();
                renderUI();
                renderLogs();
                closeModal();
            });
            return;
        }

        users[index].lastClaimDate = today;
        const now = new Date();
        logs.unshift({
            userId, site: user.site, username: user.username,
            timestamp: now.toLocaleDateString('tr-TR') + " " + now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}),
            action: "promokod alındı", date: today, type: "claim"
        });
        saveData();
        renderUI();
        renderLogs();
    }

    function renderUI() {
        const contentArea = document.getElementById('contentArea');
        contentArea.innerHTML = '';
        const today = new Date().toLocaleDateString('tr-TR');
        
        const grouped = users.reduce((acc, u) => {
            if (!acc[u.site]) acc[u.site] = [];
            acc[u.site].push(u);
            return acc;
        }, {});

        const sortedSites = Object.keys(grouped).sort();
        if (sortedSites.length === 0) {
            contentArea.innerHTML = '<div style="text-align:center; padding:30px; color:#8b949e; background:var(--card-bg); border-radius:10px;">Liste şu an boş. Kullanıcı ekleyerek başlayın.</div>';
            return;
        }

        sortedSites.forEach(site => {
            let siteHTML = `<div class="site-card">
                <div class="site-header">
                    ${siteLogos[site] ? `<img src="${siteLogos[site]}" class="site-header-logo">` : `<span>${site}</span>`}
                </div>`;
            
            grouped[site].sort((a,b) => a.username.localeCompare(b.username)).forEach(u => {
                const isClaimed = u.lastClaimDate === today;
                siteHTML += `
                    <div class="user-row">
                        <div class="user-info">
                            <span class="user-name">${u.username}</span>
                            <button class="btn-delete" onclick="deleteUser('${u.id}')">Sil</button>
                        </div>
                        <div class="led-container">
                            <div class="led ${isClaimed ? 'led-status-green' : 'led-status-gray'}" onclick="handleClaim('${u.id}')"></div>
                        </div>
                    </div>`;
            });
            siteHTML += `</div>`;
            contentArea.innerHTML += siteHTML;
        });
    }

    function renderLogs() {
        const logList = document.getElementById('logList');
        const displayLogs = logs.filter(l => l.type === "claim").slice(0, 50); 
        if (displayLogs.length === 0) {
            logList.innerHTML = '<div style="text-align:center; padding:10px; color:#6e7681;">Log kaydı yok.</div>';
            return;
        }
        logList.innerHTML = displayLogs.map(l => `
            <div class="log-item">
                <span class="log-date">${l.timestamp}</span>
                <span class="site-badge">${l.site}</span>
                <span style="color:#e6edf3;">${l.username}</span>
                <span class="action-text">✓</span>
            </div>
        `).join('');
    }

    function showModal(msg, onConfirm) {
        document.getElementById('modalMessage').innerText = msg;
        document.getElementById('confirmModal').style.display = 'flex';
        document.getElementById('confirmBtn').onclick = onConfirm;
    }

    function closeModal() { document.getElementById('confirmModal').style.display = 'none'; }
</script>

</body>
</html>
