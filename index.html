<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Every Takip Paneli PRO</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:Segoe UI,Arial;
  background:#0b1220;color:#e5e7eb;
  display:flex;height:100vh;overflow:hidden
}

/* SIDEBAR */
.sidebar{
  width:230px;background:#020617;padding:12px;
  border-right:1px solid #1e293b;overflow:auto
}
.sidebar h2{
  text-align:center;color:#facc15;margin:0 0 12px
}
.siteBtn{
  padding:10px;margin-bottom:6px;border-radius:8px;
  cursor:pointer;background:#020617;border:1px solid #020617;
  white-space:nowrap
}
.siteBtn:hover{border-color:#facc15}
.siteBtn.active{
  background:#111827;border-color:#facc15;color:#facc15
}

/* MAIN */
.main{flex:1;padding:15px;overflow:auto}

/* CARD */
.card{
  background:#020617;padding:12px;border-radius:12px;
  margin-bottom:10px;border:1px solid #1e293b
}
.card.critical{
  border-color:#ef4444;
  box-shadow:0 0 10px rgba(239,68,68,.25)
}

/* DOT */
.dot{
  width:14px;height:14px;border-radius:50%;
  background:#334155;cursor:pointer;flex:0 0 auto
}
.dot.on{
  background:#22c55e;
  box-shadow:0 0 8px rgba(34,197,94,.8)
}

/* BUTTON */
.btn{
  width:100%;padding:8px;border:none;border-radius:8px;
  margin-top:6px;cursor:pointer;font-weight:700
}
.primary{background:#16a34a;color:#fff}
.danger{background:#ef4444;color:#fff}
.soft{background:#111827;color:#e5e7eb;border:1px solid #1e293b}

/* STATUS */
.green{color:#22c55e}
.yellow{color:#facc15}
.red{color:#ef4444}
.muted{color:#94a3b8}

/* SITE BADGE */
.siteTagImg{
  display:inline-block;
  width:83px;height:24px;
  border-radius:8px;
  background-size:contain;
  background-position:center;
  background-repeat:no-repeat;
  border:1px solid #1e293b;
  background-color:#020617;
  vertical-align:middle;
  margin-left:6px;
}

/* LINK */
.linkRow{display:flex;gap:6px}
.linkRow a,.linkRow button{
  flex:1;padding:6px;border-radius:6px;
  border:1px solid #1e293b;
  background:#020617;color:#22c55e;
  cursor:pointer;text-align:center;
  text-decoration:none;font-weight:700
}

/* FILTER */
.filters button{
  margin-right:6px;padding:6px 10px;border-radius:6px;
  border:1px solid #1e293b;background:#020617;color:#fff;
  cursor:pointer
}
.filters button.active{
  border-color:#facc15;color:#facc15
}

/* INPUTS */
.inp{
  width:100%;padding:10px;border-radius:10px;
  border:1px solid #1e293b;background:#0b1220;color:#e5e7eb;
  outline:none
}
.row{display:flex;gap:8px;align-items:center}
.row > *{flex:1}
.small{font-size:12px}

/* LOG */
.logItem{
  padding:10px;border-radius:10px;border:1px solid #1e293b;
  background:#0b1220;margin-top:8px
}
.logTop{display:flex;justify-content:space-between;gap:10px}
.pill{
  display:inline-block;padding:2px 8px;border-radius:999px;
  border:1px solid #1e293b;background:#020617;
  font-size:12px;color:#cbd5e1
}

/* TOAST */
.toast{
  position:fixed;top:20px;right:20px;
  background:#facc15;color:#000;
  padding:10px 14px;border-radius:10px;
  font-weight:800;opacity:0;transition:.3s;
  z-index:999
}
.toast.show{opacity:1}

/* ===== MOBÄ°L ===== */
@media (max-width:768px){
  body{flex-direction:column;height:auto;overflow:auto}
  .sidebar{
    width:100%;display:flex;gap:6px;
    overflow-x:auto;border-right:none;
    border-bottom:1px solid #1e293b
  }
  .sidebar h2{display:none}
  .siteBtn{flex:0 0 auto;padding:8px 12px;font-size:14px}
  .main{padding:10px}
  .btn{padding:12px;font-size:15px}
  .dot{width:18px;height:18px}
  .linkRow{flex-direction:column}
  .filters button{width:100%;margin-bottom:6px}
  .toast{right:50%;transform:translateX(50%)}
  .row{flex-direction:column;align-items:stretch}
}
</style>
</head>

<body>
<div class="sidebar" id="sidebar"></div>
<div class="main" id="main"></div>
<div class="toast" id="toast"></div>

<script>
const SITES=[
  "Genel Kontrol",
  "Kavbet","Odeonbet","Jojobet","Mavibet",
  "Nakitbahis","Megabahis","Matbet","Pusulabet","Egebet"
];

const LINKS={
  "Kavbet":"https://shoort.in/kavbet",
  "Odeonbet":"http://dub.is/odeonguncel",
  "Jojobet":"http://dub.pro/jojoyagit",
  "Mavibet":"http://dub.is/maviguncel",
  "Nakitbahis":"https://shoort.in/nakitbahis",
  "Megabahis":"https://dub.is/megaguncel",
  "Matbet":"http://dub.is/matguncel",
  "Pusulabet":"https://shoort.in/pusulabet",
  "Egebet":"https://shoort.in/egebet"
};

const SITE_BADGES={
  "Jojobet":"badges/bobobet.png",
  "Egebet":"badges/egebet.png",
  "Kavbet":"badges/kavbet.png",
  "Matbet":"badges/matbet.png",
  "Mavibet":"badges/mavibet.png",
  "Megabahis":"badges/megabahis.png",
  "Nakitbahis":"badges/nakitbahis.png",
  "Odeonbet":"badges/odeonbet.png",
  "Pusulabet":"badges/pusulabet.png"
};

let active="Genel Kontrol";
let filter="all";
const KEY="everyTakip_v2";

const $=id=>document.getElementById(id);
const load=()=>JSON.parse(localStorage.getItem(KEY))||{};
const save=d=>localStorage.setItem(KEY,JSON.stringify(d));

const today=()=>new Date().toISOString().slice(0,10);
const nowStr=()=>new Date().toLocaleString("tr-TR");

function toast(m){
  const t=$("toast");
  t.textContent=m;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
}

function siteTag(site){
  const img=SITE_BADGES[site];
  return img?`<span class="siteTagImg" style="background-image:url('${img}')"></span>`:"";
}

/* ===== 7 GÃœN HESABI =====
   Son Ã¶deme tarihinden itibaren 7 gÃ¼n kod alÄ±nabilir.
   daysLeft: 0 => bugÃ¼n son gÃ¼n, -1 => sÃ¼re doldu (dÃ¼n bitti) gibi.
*/
function daysLeft(depositDate){
  if(!depositDate) return null;
  const start=new Date(depositDate);
  const diff=Math.floor((new Date() - start)/86400000); // geÃ§en gÃ¼n
  return 7 - diff; // 7,6,5..0,-1...
}
function statusText(k){
  if(k===null) return {txt:"Son Ã¶deme tarihi girilmedi", cls:"muted"};
  if(k>0) return {txt:`Kod alabilirsin: ${k} gÃ¼n kaldÄ±`, cls: (k>2?"green":"yellow")};
  if(k===0) return {txt:"BUGÃœN son gÃ¼n!", cls:"red"};
  return {txt:"SÃ¼re doldu (7 gÃ¼n geÃ§ti)", cls:"red"};
}

/* ===== FIXED DAILY RESET ===== */
function dailyReset(){
  const d=load();
  const h=new Date().getHours();
  const t=today();
  if(!d._reset) d._reset=t;

  // 03:00 sonrasÄ± yeni gÃ¼n -> tÃ¼m lastFreeSpin sÄ±fÄ±r
  if(h>=3 && d._reset!==t){
    Object.values(d).forEach(s=>{
      if(s?.users) s.users.forEach(u=>u.lastFreeSpin=null);
    });
    d._reset=t;
    save(d);
  }
}

/* ===== LOGS ===== */
function ensureLogs(d){
  if(!d._logs) d._logs=[]; // {ts, site, user, action}
  return d;
}
function addLog(site, user, action){
  const d=ensureLogs(load());
  d._logs.unshift({ts: nowStr(), site, user, action});
  // log ÅŸiÅŸmesin diye max 200 kayÄ±t
  if(d._logs.length>200) d._logs.length=200;
  save(d);
}
function clearLogs(){
  if(!confirm("TÃ¼m log temizlensin mi?")) return;
  const d=load();
  d._logs=[];
  save(d);
  renderMain();
  toast("Log temizlendi");
}

/* ===== UI ===== */
function renderSidebar(){
  const s=$("sidebar");
  s.innerHTML="<h2>EVERY TAKÄ°P</h2>";
  SITES.forEach(x=>{
    const b=document.createElement("div");
    b.className="siteBtn"+(x===active?" active":"");
    b.textContent=x;
    b.onclick=()=>{active=x;renderSidebar();renderMain();};
    s.appendChild(b);
  });
}

/* ===== GENEL KONTROL ===== */
function renderDashboard(data){
  let list=[];
  Object.entries(data).forEach(([site,val])=>{
    if(site.startsWith("_")||!val?.users) return;
    val.users.forEach(u=>{
      const k=daysLeft(u.lastDeposit);
      list.push({
        site, u,
        k,
        got: u.lastFreeSpin===today()
      });
    });
  });

  if(filter==="off") list=list.filter(x=>!x.got);
  if(filter==="on") list=list.filter(x=>x.got);
  if(filter==="dead") list=list.filter(x=>x.k!==null && x.k<=0);

  let html=`
    <h2>Genel Kontrol</h2>
    <div class="filters">
      <button onclick="filter='all';renderMain()" class="${filter==='all'?'active':''}">TÃ¼mÃ¼</button>
      <button onclick="filter='off';renderMain()" class="${filter==='off'?'active':''}">âš« AlÄ±nmadÄ±</button>
      <button onclick="filter='on';renderMain()" class="${filter==='on'?'active':''}">ğŸŸ¢ AlÄ±ndÄ±</button>
      <button onclick="filter='dead';renderMain()" class="${filter==='dead'?'active':''}">âŒ SÃ¼re Doldu</button>
    </div>
  `;

  list.forEach(x=>{
    const st=statusText(x.k);
    html+=`
      <div class="card ${(x.k!==null && x.k<=1)?'critical':''}">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="dot ${x.got?'on':''}" onclick="toggleTaken('${x.site}','${escapeHtml(x.u.username)}')"></div>
          <div style="flex:1">
            <b>${escapeHtml(x.u.username)}</b> ${siteTag(x.site)}<br>
            <span class="${st.cls}">${st.txt}</span>
          </div>
        </div>
      </div>
    `;
  });

  html += renderLogsBlock(data, /*showSiteFilter*/ true);
  $("main").innerHTML=html;
}

/* ===== SÄ°TE EKRANI ===== */
function renderSite(data){
  if(!data[active]) data[active]={users:[]};
  ensureLogs(data);

  let html=`<h2>${active}</h2>`;

  if(LINKS[active]){
    html+=`
      <div class="card">
        <b>GÃ¼ncel GiriÅŸ</b>
        <div class="linkRow">
          <a href="${LINKS[active]}" target="_blank">ğŸ”— AÃ§</a>
          <button onclick="navigator.clipboard.writeText('${LINKS[active]}');toast('KopyalandÄ±')">ğŸ“‹ Kopyala</button>
        </div>
      </div>
    `;
  }

  // kullanÄ±cÄ± ekle
  html+=`
    <div class="card">
      <input id="u" class="inp" placeholder="KullanÄ±cÄ± adÄ±">
      <button class="btn primary" onclick="addUser()">KullanÄ±cÄ± Ekle</button>
      <div class="small muted" style="margin-top:8px">
        Not: Son Ã¶deme tarihini kullanÄ±cÄ± kartÄ±ndan kaydedebilirsin.
      </div>
    </div>
  `;

  // kullanÄ±cÄ± kartlarÄ±
  data[active].users.forEach((u,i)=>{
    const k=daysLeft(u.lastDeposit);
    const st=statusText(k);

    html+=`
      <div class="card ${(k!==null && k<=1)?'critical':''}">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div>
            <b>${escapeHtml(u.username)}</b> ${siteTag(active)}<br>
            <span class="${st.cls}">${st.txt}</span>
          </div>
          <span class="pill">${u.lastFreeSpin===today() ? "BugÃ¼n alÄ±ndÄ±" : "BugÃ¼n alÄ±nmadÄ±"}</span>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="date_${i}" type="date" class="inp" value="${u.lastDeposit||""}">
          <button class="btn soft" style="margin-top:0" onclick="saveDepositDate(${i})">ğŸ’¾ Ã–deme Tarihini Kaydet</button>
        </div>

        <button class="btn primary" onclick="markTakenIdx(${i})">ğŸ Freespin AlÄ±ndÄ±</button>
        <button class="btn danger" onclick="delUser(${i})">ğŸ—‘ï¸ Sil</button>
      </div>
    `;
  });

  html += renderLogsBlock(data, /*showSiteFilter*/ false);
  $("main").innerHTML=html;
}

/* ===== LOG BLOÄU (ALTTA) ===== */
function renderLogsBlock(data, showSiteFilter){
  const logs=(data._logs||[]);
  const scoped = showSiteFilter
    ? logs
    : logs.filter(x=>x.site===active);

  let html=`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <b>LOG</b><br>
          <span class="small muted">${showSiteFilter ? "TÃ¼m siteler" : active + " (sadece bu site)"}</span>
        </div>
        <button class="btn danger" style="width:auto;margin-top:0;padding:8px 12px" onclick="clearLogs()">Temizle</button>
      </div>

      ${scoped.length===0 ? `<div class="logItem muted">HenÃ¼z kayÄ±t yok.</div>` : ""}

      ${scoped.slice(0,50).map(l=>`
        <div class="logItem">
          <div class="logTop">
            <div><b>${escapeHtml(l.user||"-")}</b> ${siteTag(l.site||"")}</div>
            <div class="muted small">${escapeHtml(l.ts||"")}</div>
          </div>
          <div class="small" style="margin-top:6px">
            <span class="pill">${escapeHtml(l.site||"")}</span>
            <span class="pill">${escapeHtml(l.action||"")}</span>
          </div>
        </div>
      `).join("")}
    </div>
  `;
  return html;
}

/* ===== ACTIONS ===== */
function addUser(){
  const v=$("u")?.value?.trim();
  if(!v) return;

  const d=load();
  if(!d[active]) d[active]={users:[]};

  // aynÄ± kullanÄ±cÄ± varsa ekleme
  if(d[active].users.some(x=>x.username.toLowerCase()===v.toLowerCase())){
    toast("Bu kullanÄ±cÄ± zaten var");
    return;
  }

  d[active].users.push({
    username:v,
    lastDeposit:null,
    lastFreeSpin:null
  });

  ensureLogs(d);
  save(d);
  $("u").value="";
  renderMain();
  toast("Eklendi");
}

function saveDepositDate(i){
  const inp=$("date_"+i);
  const v=inp ? inp.value : "";
  if(!v){
    toast("Tarih seÃ§");
    return;
  }
  const d=load();
  d[active].users[i].lastDeposit=v;
  ensureLogs(d);
  save(d);

  const k=daysLeft(v);
  const st=statusText(k);
  toast("Ã–deme tarihi kaydedildi");
  renderMain();
}

function markTakenIdx(i){
  const d=load();
  const u=d[active].users[i];
  u.lastFreeSpin=today();
  ensureLogs(d);
  save(d);

  // log
  addLog(active, u.username, "Freespin alÄ±ndÄ±");
  renderMain();
  toast("Kaydedildi");
}

function toggleTaken(site,user){
  const d=load();
  if(!d[site] || !d[site].users) return;

  const u=d[site].users.find(x=>x.username===user);
  if(!u) return;

  const was=u.lastFreeSpin===today();
  u.lastFreeSpin = was ? null : today();
  ensureLogs(d);
  save(d);

  // sadece ON yapÄ±nca log yaz
  if(!was) addLog(site, u.username, "Freespin alÄ±ndÄ± (Genel Kontrol)");

  renderMain();
}

function delUser(i){
  if(!confirm("Silinsin mi?"))return;
  const d=load();
  const u=d[active].users[i];
  d[active].users.splice(i,1);
  ensureLogs(d);
  save(d);
  addLog(active, u?.username || "-", "KullanÄ±cÄ± silindi");
  renderMain();
  toast("Silindi");
}

/* ===== HELPERS ===== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderMain(){
  dailyReset();
  const d=load();
  ensureLogs(d);
  active==="Genel Kontrol" ? renderDashboard(d) : renderSite(d);
}

renderSidebar();
renderMain();
setInterval(dailyReset,60000);
</script>
</body>
</html>
